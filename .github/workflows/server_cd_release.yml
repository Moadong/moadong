name: Release Server CD

on:
  push:
    branches:
      - 'main'
  workflow_dispatch:

env:
  ECR_REGISTRY: ${{ secrets.AWS_ECR_REGISTRY }}
  ECR_REPOSITORY: ${{ secrets.AWS_ECR_REPOSITORY_NAME }}
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build-and-push:
    name: Build and Push All Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Grant execute permission for gradlew
        run: chmod +x ./backend/gradlew
      
      # Oracle 서버 빌드에만 필요하므로 주석 처리
      # - name: Make application.properties for Oracle Server
      #   run: |
      #     cd ./backend/src/main/resources
      #     echo "${{ secrets.APPLICATION_PROD_RELEASE }}" > ./application.properties

      - name: Build with Gradle
        run: |
          cd backend
          ./gradlew clean build -x test

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Log in to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # Oracle 서버(Docker Hub) 배포에만 필요하므로 주석 처리
      # - name: Log in to Docker Hub
      #   uses: docker/login-action@v2
      #   with:
      #     username: ${{ secrets.SERVER_DOCKER_USERNAME }}
      #     password: ${{ secrets.SERVER_DOCKER_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push Docker Image to ECR
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          platforms: linux/arm64,linux/amd64
          push: true
          tags: |
            ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
            ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:latest

  # Oracle 서버 배포 잡 전체를 주석 처리
  # deploy-to-oracle:
  #   name: Deploy to Oracle Server
  #   runs-on: ubuntu-latest
  #   needs: build-and-push # 빌드 잡이 성공해야 실행
  #
  #   steps:
  #     - name: Update Container on Oracle via SSH
  #       uses: appleboy/ssh-action@master
  #       with:
  #         host: ${{ secrets.ORACLE_INSTANCE_RELEASE_IP }}
  #         username: ${{ secrets.ORACLE_INSTANCE_USER }}
  #         key: ${{ secrets.ORACLE_INSTANCE_RELEASE_PRIVATE_KEY }}
  #         port: ${{ secrets.ORACLE_INSTANCE_RELEASE_PORT }}
  #         script: |
  #           docker pull ${{ secrets.DOCKER_IMAGE_RELEASE }}:latest
  #           
  #           export USERNAME=${{ secrets.ORACLE_INSTANCE_USER }}
  #           export DOCKER_APP_IMAGE=${{ secrets.DOCKER_IMAGE_RELEASE }}:latest
  #           sudo chmod +x /home/${{ secrets.ORACLE_INSTANCE_USER }}/deploy.sh
  #           sudo -E /home/${{ secrets.ORACLE_INSTANCE_USER }}/deploy.sh
  #           
  #           docker image prune -af

  deploy-to-kubernetes:
    name: Deploy to Kubernetes with Blue/Green
    runs-on: kube
    needs: build-and-push # 빌드 잡이 성공해야 실행

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Kustomize and kubectl
        uses: imranismail/setup-kustomize@v2
      - uses: azure/setup-kubectl@v3

      - name: Setup kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG_DATA }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config
          
      - name: Blue/Green Deployment Logic
        env:
          APPLICATION_PROD_RELEASE: ${{ secrets.APPLICATION_PROD_RELEASE }}
        run: |
          # 1. 현재 라이브(Live) 환경이 블루인지 그린인지 확인
          LIVE_COLOR=$(kubectl get ingress spring-server-ingress -o jsonpath='{.spec.rules[0].http.paths[0].backend.service.name}' | cut -d'-' -f3)
          if [ "$LIVE_COLOR" == "blue" ]; then
            NEW_COLOR="green"
            OLD_COLOR="blue"
          else
            NEW_COLOR="blue"
            OLD_COLOR="green"
          fi
          echo "INFO: Current LIVE color is $LIVE_COLOR. Deploying new version to $NEW_COLOR."

          # 2. Kustomize를 사용하여 새 버전(NEW_COLOR) 배포 준비
          cd k8s/overlays/production
          
          echo "INFO: Updating image tag to ${{ env.IMAGE_TAG }} in kustomization..."
          kustomize edit set image placeholder/spring-server=${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
          
          echo "INFO: Applying new '$NEW_COLOR' deployment and service..."
          kustomize build . | kubectl apply -f - --selector="color=$NEW_COLOR"

          # 3. 새 버전 헬스체크 및 검증
          echo "INFO: Waiting for '$NEW_COLOR' deployment to be ready..."
          kubectl rollout status deployment/spring-server-$NEW_COLOR --timeout=5m
          
          # 4. 트래픽 전환
          echo "INFO: All checks passed. Switching live traffic to '$NEW_COLOR' version..."
          kubectl patch ingress spring-server-ingress --type='json' -p='[{"op": "replace", "path": "/spec/rules/0/http/paths/0/backend/service/name", "value":"spring-server-'$NEW_COLOR'-svc"}]'
          echo "INFO: Traffic successfully switched to $NEW_COLOR."

          # 5. 이전 버전(OLD_COLOR) 리소스 정리
          echo "INFO: Waiting for 60 seconds before cleaning up old '$OLD_COLOR' version..."
          sleep 60
          kubectl delete deployment spring-server-$OLD_COLOR --prune=true --grace-period=0 --force
          kubectl delete service spring-server-$OLD_COLOR-svc
          echo "INFO: Old '$OLD_COLOR' version has been cleaned up."
